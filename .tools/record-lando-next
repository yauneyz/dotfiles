#!/usr/bin/env bash
# record-lando-next
# Skip forward to next identifier on whichever counter was last modified

set -euo pipefail

CONFIG_DIR="$HOME/.config/record-lando"
STATE_FILE="$CONFIG_DIR/state"

# Check if setup has been run
if [ ! -f "$STATE_FILE" ]; then
    echo "Error: Not configured. Run record-lando-setup first."
    exit 1
fi

# Load state
source "$STATE_FILE"

# Function to convert index to identifier
get_identifier() {
    local index=$1
    local sub_index=${2:-0}

    local base_id=""
    if [ $NUM_CHALLENGES -eq 0 ]; then
        # No challenges and no hero â€” extensions only
        if [ $index -lt $NUM_EXTENSIONS ]; then
            base_id="ext-$((index + 1))"
        else
            echo "DONE"
            return
        fi
    else
        if [ $index -lt $NUM_CHALLENGES ]; then
            base_id="ch-$((index + 1))"
        elif [ $index -eq $NUM_CHALLENGES ]; then
            base_id="hero"
        elif [ $index -lt $((NUM_CHALLENGES + 1 + NUM_EXTENSIONS)) ]; then
            local ext_num=$((index - NUM_CHALLENGES))
            base_id="ext-$ext_num"
        else
            echo "DONE"
            return
        fi
    fi

    if [ $sub_index -gt 0 ]; then
        echo "${base_id}_${sub_index}"
    else
        echo "$base_id"
    fi
}

# Function to get screenshot count for current identifier
get_screenshot_count() {
    local index=$1
    local id=$(get_identifier $index)

    # Default to 1 screenshot if no config or not found
    local count=1

    if [ -n "$SCREENSHOTS_CONFIG" ]; then
        # Parse config string like "4-2,hero-3,ex1-2"
        IFS=',' read -ra PAIRS <<< "$SCREENSHOTS_CONFIG"
        for pair in "${PAIRS[@]}"; do
            if [[ "$pair" =~ ^([0-9]+|hero|ex[0-9]+)-([0-9]+)$ ]]; then
                local cfg_challenge="${BASH_REMATCH[1]}"
                local cfg_count="${BASH_REMATCH[2]}"

                # Convert challenge number to identifier format
                if [[ "$cfg_challenge" =~ ^[0-9]+$ ]]; then
                    cfg_id="ch-$cfg_challenge"
                elif [[ "$cfg_challenge" == "hero" ]]; then
                    cfg_id="hero"
                elif [[ "$cfg_challenge" =~ ^ex([0-9]+)$ ]]; then
                    cfg_id="ext-${BASH_REMATCH[1]}"
                fi

                if [ "$cfg_id" == "$id" ]; then
                    count=$cfg_count
                    break
                fi
            fi
        done
    fi

    echo $count
}

# Function to check if done
is_done() {
    local index=$1
    if [ $NUM_CHALLENGES -eq 0 ]; then
        [ $index -ge $NUM_EXTENSIONS ]
    else
        [ $index -ge $((NUM_CHALLENGES + 1 + NUM_EXTENSIONS)) ]
    fi
}

# Function to print all counter states
print_status() {
    local video_id=$(get_identifier $VIDEO_INDEX)
    local thumb_id=$(get_identifier $THUMBNAIL_INDEX)
    local screenshot_id=$(get_identifier $SCREENSHOT_INDEX $SCREENSHOT_SUB_INDEX)
    echo "Video: $video_id  Thumbnail: $thumb_id  Screenshot: $screenshot_id"
}

# Determine which counter to increment based on LAST_MODIFIED
case "$LAST_MODIFIED" in
    VIDEO)
        CURRENT_ID=$(get_identifier $VIDEO_INDEX)
        if is_done $VIDEO_INDEX; then
            echo "Video already at end. DONE!"
            print_status
            notify-send -u normal "At End" "Video already complete"
            exit 0
        fi
        NEW_INDEX=$((VIDEO_INDEX + 1))
        sed -i "s/^VIDEO_INDEX=.*/VIDEO_INDEX=$NEW_INDEX/" "$STATE_FILE"
        COUNTER_TYPE="Video"
        ;;
    THUMBNAIL)
        CURRENT_ID=$(get_identifier $THUMBNAIL_INDEX)
        if is_done $THUMBNAIL_INDEX; then
            echo "Thumbnail already at end. DONE!"
            print_status
            notify-send -u normal "At End" "Thumbnail already complete"
            exit 0
        fi
        NEW_INDEX=$((THUMBNAIL_INDEX + 1))
        sed -i "s/^THUMBNAIL_INDEX=.*/THUMBNAIL_INDEX=$NEW_INDEX/" "$STATE_FILE"
        COUNTER_TYPE="Thumbnail"
        ;;
    SCREENSHOT)
        CURRENT_ID=$(get_identifier $SCREENSHOT_INDEX $SCREENSHOT_SUB_INDEX)
        if is_done $SCREENSHOT_INDEX; then
            echo "Screenshot already at end. DONE!"
            print_status
            notify-send -u normal "At End" "Screenshot already complete"
            exit 0
        fi

        # Two-dimensional navigation: increment sub-index first, then challenge
        MAX_COUNT=$(get_screenshot_count $SCREENSHOT_INDEX)
        if [ $SCREENSHOT_SUB_INDEX -lt $MAX_COUNT ]; then
            # More screenshots for this challenge
            NEW_SUB_INDEX=$((SCREENSHOT_SUB_INDEX + 1))
            NEW_INDEX=$SCREENSHOT_INDEX
        else
            # Move to next challenge
            NEW_INDEX=$((SCREENSHOT_INDEX + 1))
            NEW_SUB_INDEX=1
        fi

        sed -i "s/^SCREENSHOT_INDEX=.*/SCREENSHOT_INDEX=$NEW_INDEX/" "$STATE_FILE"
        sed -i "s/^SCREENSHOT_SUB_INDEX=.*/SCREENSHOT_SUB_INDEX=$NEW_SUB_INDEX/" "$STATE_FILE"
        COUNTER_TYPE="Screenshot"
        ;;
    *)
        echo "Error: Unknown LAST_MODIFIED value: $LAST_MODIFIED"
        notify-send -u critical "Navigation Error" "Unknown counter: $LAST_MODIFIED"
        exit 1
        ;;
esac

# Reload state to get updated values
source "$STATE_FILE"

# Get next identifier (with sub-index for screenshots)
if [ "$COUNTER_TYPE" == "Screenshot" ]; then
    if is_done $NEW_INDEX; then
        NEXT_ID="DONE"
    else
        NEXT_ID=$(get_identifier $NEW_INDEX $NEW_SUB_INDEX)
    fi
else
    NEXT_ID=$(get_identifier $NEW_INDEX)
fi

echo "Skipped ${CURRENT_ID} on $COUNTER_TYPE."
print_status
notify-send -u normal "Next" "$COUNTER_TYPE: $NEXT_ID (skipped $CURRENT_ID)"
